# The MIT License (MIT)
# Copyright (c) 2016 Intel Corporation
#
# Permission is hereby granted, free of charge, to any person obtaining a copy of 
# this software and associated documentation files (the "Software"), to deal in 
# the Software without restriction, including without limitation the rights to 
# use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of 
# the Software, and to permit persons to whom the Software is furnished to do so, 
# subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all 
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS 
# FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR 
# COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER 
# IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN 
# CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

---
- name     : Set fact ssh_dest_dir
  set_fact : ssh_dest_dir=/home/{{owner_user_name}}/.ssh
  when     : ssh_dest_dir is not defined

- name     : Set fact ssh_proxy
  set_fact : ssh_proxy="{{default_ssh_proxy}}"
  when     : ssh_proxy is not defined

- name : Fix permissions on the .ssh folder if necessary
  file :
    path    : "{{ssh_dest_dir}}"
    group   : "{{group_name}}"
    owner   : "{{owner_user_name}}"
    mode    : "0700"
    state   : directory
    recurse : yes

- name       : Setup ssh config
  lineinfile :
    dest         : "{{ssh_dest_dir}}/config"
    line         : "Host github.com"
    insertbefore : BOF
    create       : yes
    group        : "{{group_name}}"
    owner        : "{{owner_user_name}}"
    mode         : "0600"

- name       : Setup ssh config with proxy command 
  lineinfile :
    dest        : "{{ssh_dest_dir}}/config"
    line        : "    {{ssh_proxy}}"
    insertafter : "Host github.com"
  when       : ssh_proxy is defined and ssh_proxy != ""
